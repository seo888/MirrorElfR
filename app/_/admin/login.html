<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />
  <title>Mirror-Elf 管理后台</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=Edge" />

  <link rel="stylesheet" title="default" href="https://unpkg.com/amis@6.13.0/sdk/antd.css" />
  <link rel="stylesheet" href="https://unpkg.com/amis@6.13.0/sdk/helper.css" />
  <script src="https://unpkg.com/amis@6.13.0/sdk/sdk.js"></script>
  <script src="https://unpkg.com/vue@2"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.0.0/core.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/md5.js"></script>
  <style>
    html,
    body,
    .app-wrapper {
      position: relative;
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
    }

    .loginTitle {
      text-align: center;
    }

    .loginTitle p {
      margin: 10px auto;
      color: black;
      font-size: 25px;
    }
  </style>
</head>

<body>
  <div id="root" class="app-wrapper"></div>
  <script>
  (function () {
    let amis = amisRequire('amis/embed');

    Vue.config.productionTip = false;
    Vue.config.devtools = false;

    const serverUrl = location.origin;

    // 添加动画样式
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
      @keyframes slideOut {
        from {
          transform: translateX(0);
          opacity: 1;
        }
        to {
          transform: translateX(100%);
          opacity: 0;
        }
      }
    `;
    document.head.appendChild(style);

    const app = {
      type: 'page',
      title: "",
      style: {
        "backgroundImage": "linear-gradient(180deg, #86a4e9, transparent)"
      },
      body: {
        "type": "grid-2d",
        "cols": 12,
        "grids": [{
          x: 5,
          y: 5,
          h: 1,
          w: 4,
          width: 200,
          type: 'form',
          mode: 'horizontal',
          title: "",
          api: {
            url: "/_api/login",
            method: "post",
            requestAdaptor: function(api) {
              console.log('请求数据:', api.data);
              
              // 显示加载状态
              const submitBtn = document.querySelector('[type="submit"]');
              if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> 登录中...';
              }
              
              // 将数据转换为表单格式
              const formData = new URLSearchParams();
              if (api.data) {
                Object.keys(api.data).forEach(key => {
                  formData.append(key, api.data[key]);
                });
              }
              
              return {
                ...api,
                data: formData.toString(),
                headers: {
                  ...api.headers,
                  'Content-Type': 'application/x-www-form-urlencoded',
                  'Accept': 'application/json'
                }
              };
            },
            adaptor: function (payload, response) {
              console.log('登录响应:', payload);
              
              // 恢复按钮状态
              const submitBtn = document.querySelector('[type="submit"]');
              if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '登录';
              }
              
              try {
                // 解析 JSON 响应
                const data = typeof payload === 'string' ? JSON.parse(payload) : payload;
                
                if (data.success === true) {
                  // 登录成功
                  
                  // 延迟跳转
                  setTimeout(() => {
                    window.location.href = data.redirect || '/_api_/index';
                  }, 500);
                  
                  return {
                    status: 0,
                    msg: data.message || '登录成功',
                    data: data
                  };
                } else {
                  // 登录失败
                  
                  return {
                    status: response.status || 500,
                    msg: data.message || '登录失败',
                    data: data
                  };
                }
              } catch (e) {
                console.error('解析响应失败:', e);
                
                // 如果解析失败，显示通用错误
                
                return {
                  status: -1,
                  msg: '响应格式错误',
                  data: null
                };
              }
            }
          },
          panelClassName: "p-r p-l p-b-md",
          body: [
            {
              "type": "tpl",
              "tpl": "<div class='loginTitle'><p>Mirror-Elf 管理后台</p></div>"
            },
            {
              type: "input-text",
              label: false,
              name: "login_account",
              size: "full",
              placeholder: "用户名",
              value: "admin",
              required: true,
              addOn: {
                "label": "",
                "type": "text",
                "position": "left",
                "icon": "fa fa-user"
              },
            },
            {
              type: "input-password",
              label: false,
              name: "login_password",
              size: "full",
              placeholder: "密码",
              value: "admin",
              required: true,
              addOn: {
                "label": "",
                "type": "text",
                "position": "left",
                "icon": "fa fa-lock"
              },
            },
            {
              type: "checkbox",
              label: false,
              name: "record",
              option: "记住密码"
            },
            {
              type: "control",
              label: false,
              body: {
                "type": "button",
                "level": "primary",
                "actionType": "submit",
                "block": true,
                "label": "登录"
              }
            }
          ]
        }]
      }
    };

    amis.embed(
      '#root',
      app, {
      serverUrl: serverUrl
    }, {
      theme: 'antd',
    }
    );

  })();
</script>
</body>

</html>